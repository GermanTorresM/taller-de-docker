



<!DOCTYPE html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Taller de introducción a docker">
      
      
      
        <meta name="author" content="Sergio Gómez <sergio@uco.es>">
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="es">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/logoasl.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Crear imágenes propias - Taller de Docker</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../extra.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#crear-imagenes-propias" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Taller de Docker" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Taller de Docker
              </span>
              <span class="md-header-nav__topic">
                Crear imágenes propias
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/aulasoftwarelibre/taller-de-docker.git/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      aulasoftwarelibre/taller-de-docker
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Taller de Docker" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Taller de Docker
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/aulasoftwarelibre/taller-de-docker.git/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      aulasoftwarelibre/taller-de-docker
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Inicio" class="md-nav__link">
      Inicio
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../introduction/" title="Introducción" class="md-nav__link">
      Introducción
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../installation/" title="Instalación" class="md-nav__link">
      Instalación
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../images/" title="Imágenes" class="md-nav__link">
      Imágenes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../containers/" title="Contenedores" class="md-nav__link">
      Contenedores
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../data/" title="Persistiendo datos" class="md-nav__link">
      Persistiendo datos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../wordpress/" title="Levantar un WordPress con Docker" class="md-nav__link">
      Levantar un WordPress con Docker
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../docker-compose/" title="Levantar un WordPress con Docker Compose" class="md-nav__link">
      Levantar un WordPress con Docker Compose
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Crear imágenes propias
      </label>
    
    <a href="./" title="Crear imágenes propias" class="md-nav__link md-nav__link--active">
      Crear imágenes propias
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mi-primer-dockerfile" title="Mi primer Dockerfile" class="md-nav__link">
    Mi primer Dockerfile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creando-aplicaciones-en-contenedores" title="Creando aplicaciones en contenedores" class="md-nav__link">
    Creando aplicaciones en contenedores
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probar-nuestro-contenedor" title="Probar nuestro contenedor" class="md-nav__link">
    Probar nuestro contenedor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creando-la-aplicacion" title="Creando la aplicación" class="md-nav__link">
    Creando la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balanceo-de-carga" title="Balanceo de carga" class="md-nav__link">
    Balanceo de carga
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compartir-imagenes" title="Compartir imágenes" class="md-nav__link">
    Compartir imágenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicios" title="Ejercicios:" class="md-nav__link">
    Ejercicios:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../tips/" title="Trucos" class="md-nav__link">
      Trucos
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mi-primer-dockerfile" title="Mi primer Dockerfile" class="md-nav__link">
    Mi primer Dockerfile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creando-aplicaciones-en-contenedores" title="Creando aplicaciones en contenedores" class="md-nav__link">
    Creando aplicaciones en contenedores
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#probar-nuestro-contenedor" title="Probar nuestro contenedor" class="md-nav__link">
    Probar nuestro contenedor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creando-la-aplicacion" title="Creando la aplicación" class="md-nav__link">
    Creando la aplicación
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balanceo-de-carga" title="Balanceo de carga" class="md-nav__link">
    Balanceo de carga
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compartir-imagenes" title="Compartir imágenes" class="md-nav__link">
    Compartir imágenes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ejercicios" title="Ejercicios:" class="md-nav__link">
    Ejercicios:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aulasoftwarelibre/taller-de-docker.git/edit/master/docs/dockerfile.md" title="Editar esta página" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="crear-imagenes-propias">Crear imágenes propias<a class="headerlink" href="#crear-imagenes-propias" title="Permanent link">&para;</a></h1>
<p>Ya hemos visto como usar imágenes de terceros para crear aplicaciones y servicios. Pero, ¿si no hay ninguna imagen que tenga lo que queremos? ¿O si queremos hacer una imagen de nuestra aplicación para distribuirla?</p>
<p>Docker permite crear imagenes propias. Aunque podríamos hacerla partiendo de cero, es un esfuerzo que no tiene sentido. Existe ya imágenes base para crear las nuestras y es mucho más fácil crear una imagen basándose en otra que hacerlo todo nosotros.</p>
<p>Podemos partir de una imagen base que parte de un lenguaje de programación (<em>python</em>, <em>php</em>) o de alguna distribución (<em>ubuntu</em>, <em>debian</em>).</p>
<h2 id="mi-primer-dockerfile">Mi primer Dockerfile<a class="headerlink" href="#mi-primer-dockerfile" title="Permanent link">&para;</a></h2>
<p>Los <em>Dockerfile</em> son los archivos que contienen las instrucciones que crean las imagenes. Deben estar guardados dentro de un <em>build context</em>, es decir, un directorio. Este directorio es el que contiene todos los archivos necesarios para construir nuestra imagen, de ahí lo de <em>build context</em>.</p>
<p>Creamos nuestro <em>build context</em></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mkdir -p  ~/Sites/hello-world
cd ~/Sites/hello-world
echo &quot;hello&quot; &gt; hello
</pre></div>
</td></tr></table>

<p>Dentro de este directorio crearemos un archivo llamado <em>Dockerfile</em> con este contenido:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>FROM busybox
COPY /hello /
RUN cat /hello
</pre></div>
</td></tr></table>

<table>
<thead>
<tr>
<th>Directiva</th>
<th>Explicación</th>
</tr>
</thead>
<tbody>
<tr>
<td>FROM</td>
<td>Indica la imagen base sobre la que se basa esta imagen</td>
</tr>
<tr>
<td>COPY</td>
<td>Copia un archivo del <em>build context</em> y lo guarda en la imagen</td>
</tr>
<tr>
<td>RUN</td>
<td>Ejecuta el comando indicado durante el proceso de creación de imagen.</td>
</tr>
</tbody>
</table>
<p>Ahora para crear nuestra imagen usaremos <code>docker build</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker build -t helloapp:v1 .
</pre></div>
</td></tr></table>

<p>El parámetro <code>-t</code> nos permite etiquetar la imagen con un nombre y una versión. El <code>.</code> indica que el <em>build context</em> es el directorio actual.</p>
<p>El resultado de ejecutar lo anterior sería:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker build -t helloapp:v1 .
Sending build context to Docker daemon  3.072kB
Step 1/3 : FROM busybox
latest: Pulling from library/busybox
8c5a7da1afbc: Pull complete 
Digest: sha256:cb63aa0641a885f54de20f61d152187419e8f6b159ed11a251a09d115fdff9bd
Status: Downloaded newer image for busybox:latest
 ---&gt; e1ddd7948a1c
Step 2/3 : COPY /hello /
 ---&gt; 8a092965dbc9
Step 3/3 : RUN cat /hello
 ---&gt; Running in 83b5498790ca
hello
Removing intermediate container 83b5498790ca
 ---&gt; f738f117d4b6
Successfully built f738f117d4b6
Successfully tagged helloapp:v1
</pre></div>
</td></tr></table>

<p>Y podremos ver que una nueva imagen está instalada en nuestro equipo:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker images
REPOSITORY   TAG  IMAGE ID      CREATED         SIZE
helloapp     v1   f738f117d4b6  40 seconds ago  1.16MB
</pre></div>
</td></tr></table>

<h2 id="creando-aplicaciones-en-contenedores">Creando aplicaciones en contenedores<a class="headerlink" href="#creando-aplicaciones-en-contenedores" title="Permanent link">&para;</a></h2>
<p>Vamos a crear un aplicación en python y la vamos a guardarla en un contenedor. Comenzamos creando un nuevo <em>build context</em>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>mkdir -p  ~/Sites/friendlyhello
cd ~/Sites/friendlyhello
</pre></div>
</td></tr></table>

<p>El código de la aplicación es el siguiente, lo guardaremos en un archivo llamado <code>app.py</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">redis</span> <span class="kn">import</span> <span class="n">Redis</span><span class="p">,</span> <span class="n">RedisError</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="c1"># Connect to Redis</span>
<span class="n">redis</span> <span class="o">=</span> <span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;redis&quot;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">socket_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">visits</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;counter&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">RedisError</span><span class="p">:</span>
        <span class="n">visits</span> <span class="o">=</span> <span class="s2">&quot;&lt;i&gt;cannot connect to Redis, counter disabled&lt;/i&gt;&quot;</span>

    <span class="n">html</span> <span class="o">=</span> <span class="s2">&quot;&lt;h3&gt;Hello {name}!&lt;/h3&gt;&quot;</span> \
           <span class="s2">&quot;&lt;b&gt;Hostname:&lt;/b&gt; {hostname}&lt;br/&gt;&quot;</span> \
           <span class="s2">&quot;&lt;b&gt;Visits:&lt;/b&gt; {visits}&quot;</span>
    <span class="k">return</span> <span class="n">html</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;world&quot;</span><span class="p">),</span> <span class="n">hostname</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>  <span class="n">visits</span><span class="o">=</span><span class="n">visits</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>Nuestra aplicación tiene una serie de dependencias (librerías de terceros) que guardaremos en el archivo <em>requirements.txt</em>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Flask
Redis
</pre></div>
</td></tr></table>

<p>Y por último definimos nuestro <em>Dockerfile</em>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="codehilite"><pre><span></span># Partimos de una base oficial de python
FROM python:2.7-slim

# El directorio de trabajo es desde donde se ejecuta el contenedor al iniciarse
WORKDIR /app

# Copiamos todos los archivos del build context al directorio /app del contenedor
COPY . /app

# Ejecutamos pip para instalar las dependencias en el contenedor
RUN pip install --trusted-host pypi.python.org -r requirements.txt

# Indicamos que este contenedor se comunica por el puerto 80/tcp
EXPOSE 80

# Declaramos una variable de entorno
ENV NAME World

# Ejecuta nuestra aplicación cuando se inicia el contenedor
CMD [&quot;python&quot;, &quot;app.py&quot;]
</pre></div>
</td></tr></table>

<p>Para conocer todas las directivas visita la <a href="https://docs.docker.com/engine/reference/builder/">documentación oficial de Dockerfile</a>.</p>
<p>En total debemos tener 3 archivos:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ ls
app.py  Dockerfile  requirements.txt
</pre></div>
</td></tr></table>

<p>Ahora construimos la imagen de nuestra aplicación:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker build -t friendlyhello .
</pre></div>
</td></tr></table>

<p>Y comprobamos que está creada:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
friendlyhello       latest              88a822b3107c        56 seconds ago      132MB
</pre></div>
</td></tr></table>

<h3 id="probar-nuestro-contenedor">Probar nuestro contenedor<a class="headerlink" href="#probar-nuestro-contenedor" title="Permanent link">&para;</a></h3>
<p>Vamos a arrancar nuestro contenedor y probar la aplicación:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker run --rm -p 4000:80 friendlyhello
</pre></div>
</td></tr></table>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Normalmente los contenedores son de usar y tirar, sobre todo cuando hacemos pruebas. El parámetro <code>--rm</code> borra automáticamente un contenedor cuando se para. Recordemos que los datos volátiles siempre se deben guardar en volúmenes.</p>
</div>
<p>Lo que arranca la aplicación Flask:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker run --rm -p 4000:80 friendlyhello
 * Serving Flask app &quot;app&quot; (lazy loading)
 * Environment: production
   WARNING: Do not use the development server in a production environment.
   Use a production WSGI server instead.
 * Debug mode: off
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
</pre></div>
</td></tr></table>

<p>Comprobamos en el puerto 4000 si efectivamente está iniciada o no: <a href="http://localhost:4000">http://localhost:4000</a>.</p>
<p>Obtendremos un mensaje como este:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Hello World!

Hostname: 0367b056e66e
Visits: cannot connect to Redis, counter disabled
</pre></div>
</td></tr></table>

<p>Ya tenemos una imagen lista para ser usada. Pulsamos <code>Control+C</code> para interrumpir y borrar nuestro contenedor.</p>
<h3 id="creando-la-aplicacion">Creando la aplicación<a class="headerlink" href="#creando-la-aplicacion" title="Permanent link">&para;</a></h3>
<p>En este caso nuestro contenedor no funciona por sí mismo. Es muy habitual que dependamos de servicios para poder iniciar la aplicación, habitualmente bases de datos. En este caso necesitamos una base de datos <em>Redis</em> que no tenemos.</p>
<p>Como vimos en el apartado anterior, vamos a aprovechar las características de <em>Compose</em> para levantar nuestra aplicación.</p>
<p>Vamos a crear el siguiente archivo <em>docker-compose.yaml</em>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="s">&quot;3&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">services</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">web</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">build</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">.</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&quot;4000:80&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">redis</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">redis</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&quot;6379:6379&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="s">&quot;./data:/data&quot;</span>
        <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">redis-server --appendonly yes</span>
</pre></div>
</td></tr></table>

<p>La principal diferencia con respecto al capítulo anterior, es que en un servicio podemos indicar una imagen (parámetro <code>imagen</code>) o un <em>build context</em> (parámetro <code>build</code>). </p>
<p>Esta es una manera de integrar las dos herramientas que nos proporciona <em>Docker</em>: la creación de imágenes y la composición de aplicaciones con servicios.</p>
<h3 id="balanceo-de-carga">Balanceo de carga<a class="headerlink" href="#balanceo-de-carga" title="Permanent link">&para;</a></h3>
<p>Vamos a modificar nuestro <em>docker-compose.yaml</em>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>version: &quot;3&quot;
services:
    web:
        build: .
    redis:
        image: redis
        volumes:
            - &quot;./data:/data&quot;
        command: redis-server --appendonly yes
    lb:
        image: dockercloud/haproxy
        ports:
            - 4000:80
        links:
            - web
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
</pre></div>
</td></tr></table>

<p>En este caso, el servicio web no va a tener acceso al exterior (hemos eliminado el parámetro <code>ports</code>). En su lugar hemos añadido un balanceador de carga (el servicio  <code>lb</code>).</p>
<p>Vamos a arrancar esta nueva aplicación, pero esta vez añadiendo varios servicios web:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>docker-composer up -d --scale web=5
</pre></div>
</td></tr></table>

<p>Esperamos a que terminen de iniciar los servicios:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker-compose up -d --scale web=5
Creating network &quot;friendlyhello_default&quot; with the default driver
Creating friendlyhello_redis_1 ... done
Creating friendlyhello_web_1   ... done
Creating friendlyhello_web_2   ... done
Creating friendlyhello_web_3   ... done
Creating friendlyhello_web_4   ... done
Creating friendlyhello_web_5   ... done
Creating friendlyhello_lb_1    ... done
</pre></div>
</td></tr></table>

<p>Podemos comprobar como del servicio web nos ha iniciado 5 instancias, cada uno con su sufijo numérico correspondiente. Si usamos <code>docker ps</code> para ver los contenedores disponibles tendremos:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker ps
CONTAINER ID  IMAGE                [...]   PORTS                                    NAMES
77acae1d0567  dockercloud/haproxy  [...]   443/tcp, 1936/tcp, 0.0.0.0:4000-&gt;80/tcp  friendlyhello_lb_1
5f12fb8b80c8  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_5
fb0024591665  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_2
a20d20bdd129  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_4
53d7db212df8  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_3
41218dbbb882  friendlyhello_web    [...]   80/tcp                                   friendlyhello_web_1
06f5bf6ed070  redis                [...]   6379/tcp                                 friendlyhello_redis_1
</pre></div>
</td></tr></table>

<p>Vamos a fijarnos en el <code>CONTAINER ID</code> y vamos a volver a abrir nuestra aplicación: <a href="http://localhost:4000">http://localhost:4000</a>.</p>
<p>Si en esta ocasión vamos recargando la página, veremos como cambian los <em>hostnames</em>, que a su vez coinciden con los identificadores de los contenedores anteriores.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Esta no es la manera adecuada de hacer balanceo de carga, puesto que todos los contenedores están en la misma máquina, lo cual no tiene sentido. Solo es una demostración. Para hacer balanceo de carga real necesitaríamos tener o emular un clustes de máquinas y crear un enjambre (<em>swarm</em>).</p>
</div>
<h2 id="compartir-imagenes">Compartir imágenes<a class="headerlink" href="#compartir-imagenes" title="Permanent link">&para;</a></h2>
<p>Si tenemos una imagen que queramos compartir, necesitamos usar un registro. Existe incluso una imagen que nos permite crear uno propio, pero vamos a usar el repositorio público de <em>Docker</em>.</p>
<p>Los pasos son:</p>
<ol>
<li>Crear una cuenta de usuario en el <a href="https://hub.docker.com">repositorio oficial de <em>Docker</em></a>.</li>
<li>Pulsar sobre el botón "<em>Create Repository +</em>".</li>
<li>
<p>En el formulario hay que rellenar solo un dato obligatoriamente: el nombre. Usaremos el de la imagen: <em>friendlyhello</em>.</p>
<p>Nuestro nombre de usuario es el namespace y es obligatorio que tenga uno. Si estuvieramos en alguna organización podríamos elegir entre varios. El resto de campos lo dejamos como está por el momento. La cuenta gratuita solo deja tener un repositorio privado, asi que no lo malgastaremos aquí.</p>
</li>
<li>
<p>Ahora tenemos que conectar nuestro cliente de <em>Docker</em> con nuestra cuenta en el <em>Hub</em>. Usamos el comando <code>docker login</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don&#39;t have a Docker ID, head over to https://hub.docker.com to create one.
Username: username
Password: ********
WARNING! Your password will be stored unencrypted in /home/sergio/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store
</pre></div>
</td></tr></table>

<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Las claves se guardan sin cifrar. Hay que configurar un almacen de claves o recordar hacer <code>docker logout</code> para borrarla.</p>
<p>Visita <a href="https://docs.docker.com/engine/reference/commandline/login/#credentials-store">la web de referencia para saber como crear un almacen</a>.</p>
</div>
</li>
<li>
<p>Para que las imágenes se puedan guardar, tenemos que etiquetarla con el mismo nombre que tengamos en nuestro repositorio más el <em>namespace</em>. Si nuestra cuenta es '<em>username</em>' y el repositorio es '<em>friendlyhello</em>', debemos crear la imagen con la etiqueta '<em>username/friendlyhello</em>'.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker build -t username/friendlyhello .
</pre></div>
</td></tr></table>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Por defecto ya hemos dicho que la etiqueta si no se indica es <em>latest</em>. Podemos indicar más de una etiqueta para indicar versiones:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker build -t username/friendlyhello -t username/friendlyhello:0.1.0 .
</pre></div>
</td></tr></table>

<p>En la próxima que hagamos le subimos la versión en la etiqueta:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker build -t username/friendlyhello -t username/friendlyhello:0.2.0 .
</pre></div>
</td></tr></table>

<p>De esta manera nuestra imagen aparecerá con tres etiquetas: <em>latest</em> y <em>0.2.0</em> que serán la misma en realidad, y <em>0.1.0</em>.</p>
</div>
</li>
<li>
<p>Ahora ya podemos enviar nuestra imagen:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>$ docker push username/friendlyhello
</pre></div>
</td></tr></table>

</li>
</ol>
<h2 id="ejercicios">Ejercicios:<a class="headerlink" href="#ejercicios" title="Permanent link">&para;</a></h2>
<ol>
<li>Cambia el <em>docker-compose.yaml</em> para usar tu imagen en vez de hacer <em>build</em>.</li>
<li>Cambia el <em>docker-compose.yaml</em> para usar la imagen de algún compañero. </li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../docker-compose/" title="Levantar un WordPress con Docker Compose" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Anterior
                </span>
                Levantar un WordPress con Docker Compose
              </span>
            </div>
          </a>
        
        
          <a href="../tips/" title="Trucos" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Siguiente
                </span>
                Trucos
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/aulasoftwarelibre" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/aulasl" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://facebook.com/aulasl" class="md-footer-social__link fa fa-facebook"></a>
    
      <a href="https://instagram.com/aulasoftwarelibre" class="md-footer-social__link fa fa-instagram"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.583bbe55.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
                <script src="../assets/javascripts/lunr/lunr.es.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-51754922-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>